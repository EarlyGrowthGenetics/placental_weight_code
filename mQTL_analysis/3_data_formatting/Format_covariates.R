#\---------------------------------------------------- Description ----------------------------------------------------#
# Format covariates file to tensorQTL requirements.
#/---------------------------------------------------------------------------------------------------------------------#

#\------------------------------------------------------ Library ------------------------------------------------------#
library(dplyr)
#/---------------------------------------------------------------------------------------------------------------------#

#\----------------------------------------------------- Load data -----------------------------------------------------#
args = commandArgs(trailingOnly=TRUE)

samples <- read.table(args[1])
cell_type_placenta <- read.table(args[2], header=T)
covars <- read.csv(args[3], header=T)
pcs <- read.table(args[4], header=T)
logFile <- args[5]
savePath <- args[6]

file.create(logFile)
sink(logFile, append = T, split=T)
#/---------------------------------------------------------------------------------------------------------------------#

#\----------------------------------------------------- Merge data ----------------------------------------------------#
cat("########################################\nMerge data\n########################################\n")
pheno <- merge(cell_type_placenta, covars, by.x=0, by.y=0)
pheno <- merge(pheno, pcs, by.x="Sample_Name", by.y=1)
#/---------------------------------------------------------------------------------------------------------------------#

#\---------------------------------------------------- Format data ----------------------------------------------------#
cat("########################################\nSubset data\n########################################\n")
pheno <- subset(pheno, Sample_Name %in% samples$V1)
pheno <- select(pheno, c("Sample_Name", "V1", "V2", "V3", "V4", "Delivery_Sex", colnames(cell_type_placenta)))
dim(pheno)

cat("########################################\nFormat data\n########################################\n")
colnames(pheno)[1:6] <- c("ID", "Gen_PC1", "Gen_PC2", "Gen_PC3", "Gen_PC4", "Sex")
pheno <- pheno[order(as.numeric(pheno$ID)),]
colnames(pheno)
table(pheno$Sex)

recodeSex <- function(sex){
    if(is.na(sex) | sex == ""){
        NA
    } else if(sex == "Male"){
        0
    } else if(sex == "Female"){
        1
    }
}

pheno$Sex <- sapply(pheno$Sex, recodeSex, USE.NAMES=F)

cat("########################################\nTranspose data\n########################################\n")
pheno_t <- as.data.frame(t(pheno))
dim(pheno_t)
#/---------------------------------------------------------------------------------------------------------------------#

#\-------------------------------------------------------- Save -------------------------------------------------------#
write.table(pheno_t, file=savePath, quote=F, col.names=F, sep="\t")
sink()
#/---------------------------------------------------------------------------------------------------------------------#